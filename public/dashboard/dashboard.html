<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/Logo/Logo_FundoAmarelo.png" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEANY1 | Dashboards</title>

    
    <link rel="stylesheet" href="./../css/dashboards.css">
    <link rel="stylesheet" href="./../css/estilo.css" />
    <script src="../js/sessao.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!--FONT AWESOME-->
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<!-- <body onload=" atualizarFeed()"> -->

<body>

    <div class="janela">
        <div class="header-left">
            <img width="80px" src="../assets/Logo/Logo_FundoAmarelo.png" alt="logo_beany1">
            <div class="hello">
                <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
            </div>
            <hr width="80%">

            <div class="btn-nav">

                <h3>GRÁFICOS</h3>

            </div>

            <div class="btn-nav-white">
                <a href="./inserir.html">
                    <h3>INSERIR DADOS</h3>
                </a>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>SAIR</h3>
            </div>

        </div>

        <div class="dash">
            <div id="banner-mapa">
                <h1 id="banner-mapa-titulo">Oregon</h1>
            </div>
            <div class="btns-dash" id="btnPartida">
                <!-- O gráfico é chamado de acordo com o id (fk_aquario) do banco  -->
            </div>
            <!-- Abaixo aparece os gráficos -->
            <div id="graficos">
            </div>
        </div>
    </div>


</body>

</html>

<script>
    // Abaixo, busca o NOME_USUARIO salvo no sessionStorage(salvo no histórico da sessão)
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    // Define uma "variável" chamada proximaAtualizacao;
    let proximaAtualizacao;
    var idUsuario = sessionStorage.ID_USUARIO;
    let ultimoIdPartida = null;
 
    // Após a janela/página carregar, realiza a função exibirPartidasDoUsuario
    window.onload = exibirPartidasDoUsuario;

    // Função pra exibir as partidas do usuário em si
    function exibirPartidasDoUsuario() {
        // Abaixo define a var partidas em formato JSON, pegando os dados e definindo como objetos(as PARTIDAS no caso)
        var partidas = JSON.parse(sessionStorage.PARTIDAS);
        // Abaixo, pega cada partida e define pra aparecer e exibir o botão
        partidas.forEach(item => {
            document.getElementById("btnPartida").innerHTML += `
            <button class="btn-chart" onclick="exibirPartidas(${item.idPartida})" id="btnPartida${item.idPartida}">${item.mapa}</button>
            `

            // Abaixo define pra aparecer na div.idGraficos as seguintes configs:
            // Titulo como mapa
            // o Gráfico
            // Aviso da captura
            document.getElementById("graficos").innerHTML += `
                <div id="grafico${item.idPartida}" class="display-none">
                    <div class="graph">
                        <canvas id="myChartCanvas${item.idPartida}"></canvas>
                    </div>
                </div>
            `

            document.getElementById("banner-mapa-titulo").innerHTML = `
            <h1 class="banner-mapa.titulo">
                        <span id="tituloPartida${item.idPartida}">${item.mapa}</span>
            </h1>`

            // Aqui chama a função obterDadosGrafico pegando a var item.idPartida
            obterDadosGrafico(item.idPartida)
        });

        // Se o número de partidas for maior que 0, exibe gráficos
        if (partidas.length > 0) {
            exibirPartidas(partidas[0].idPartida)
        }
    }

    // Função para alterar o título de cada gráfico
    function alterarTitulo(idPartida) {
        // Define var tituloPartida pegando o ID do elemento.
        var tituloPartida = document.getElementById(`tituloPartida${idPartida}`)
        // Define var como JSON e pega os objetos no sessionStorage, encontrando um idPartida similar e o nome do mapa
        var mapa = JSON.parse(sessionStorage.PARTIDAS).find(item => item.idPartida == idPartida).mapa;
        tituloPartida.innerHTML = "<span style='color: #e6005a'>" + mapa + "</span>"
    }

    // função para exibir as partidas que estão no Banco de Dados
    function exibirPartidas(idPartida) {
        // Aqui busca todas as partidas no BD e define como objetos/parse
        let todosOsGraficos = JSON.parse(sessionStorage.PARTIDAS);

        // Define cont como 0, e enquanto o total de gráficos for maior que o contador, faz a função
        for (i = 0; i < todosOsGraficos.length; i++) {
            // exibindo (ou não) o gráfico
            if (todosOsGraficos[i].idPartida != idPartida) {
                // Define "var" como elemento atual, onde irá no elemento que estava com display none
                // Acima e pega o id do gráfico
                let elementoAtual = document.getElementById(`grafico${todosOsGraficos[i].idPartida}`)
                // Se conter display block, irá remover logo após.
                if (elementoAtual.classList.contains("display-block")) {
                    elementoAtual.classList.remove("display-block")
                }
                // Define o elemento atual como display none
                elementoAtual.classList.add("display-none")

                // Alterando estilo do botão, definindo a "var" como gráfico
                let btnAtual = document.getElementById(`btnPartida${todosOsGraficos[i].idPartida}`)
                // Se conter botão de classe pink, remove.
                if (btnAtual.classList.contains("btn-pink")) {
                    btnAtual.classList.remove("btn-pink")
                }
                // Define botão como estilo/classe branco
                btnAtual.classList.add("btn-white")
            }
        }

        // exibindo - ou não - o gráfico
        // Define "var" com adquirindo id da partida
        let graficoExibir = document.getElementById(`grafico${idPartida}`)
        // remove o estilo de display none
        graficoExibir.classList.remove("display-none")
        // Deixa como display block pra aparecer o gráfico
        graficoExibir.classList.add("display-block")

        // Alterando estilo do botão
        let btnExibir = document.getElementById(`btnPartida${idPartida}`)
        // Remove estilo branco
        btnExibir.classList.remove("btn-white")
        // Coloca estilo rosa no botão
        btnExibir.classList.add("btn-pink")
    }

    // O gráfico é construído com três funções:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
    // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
    // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

    // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de partidas.
    // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
    // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function obterDadosGrafico(idPartida) {

        // Abaixo fica alterando o título dependendo da patida escolhida
        alterarTitulo(idPartida)

        // Se a proximaAtualização não esta definida ainda, vai reiniciar o tempo pra atualizar
        // (Nesse caso, não vai atualizar)
        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        // Vai buscar em rotas o arquivo ultimas(partidas) e pega pelo idPartida, 
        // define como sem cache e então, define a função resposta.
        fetch(`/medidasPartidas/ultimas/${idUsuario}`, { cache: 'no-store' }).then(function (response) {
            // Se response der certo, então pega a função resposta em formato json
            // e aparece no console.log os dados que receber do BD,
            // formatando em formato string e plotando os gráficos
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    // plota os gráficos a partir do idPartida e com uma resposta
                    plotarGrafico(resposta, idPartida);

                });
            } else {
                // Se tiver buscado (ou der erro) e não ter encontrado, exibe que deu erro na API
                // ou não tem dados na API
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
        // captura o erro e exibe a sua mensagem junto com o problema
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(resposta, idPartida) {

        // Aparece no console que está iniciando
        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        // Labels seriam o título de cada informação, onde nesse caso seria:
        // Kills, Deaths, Mapa, etc (nesse caso os nomes das colunas na tabela partidas)
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        // Aqui é onde fica as mortes e kills do usuário
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Kills',
                data: [],
                fill: false,
                backgroundColor: 'black',
                borderColor: 'black',
                borderWidth: 3,
                tension: 0.1
            },
            {
                label: 'Deaths',
                data: [],
                fill: false,
                backgroundColor: '#D9A303',
                borderColor: '#D9A303',
                borderWidth: 3,
                tension: 0.1
            },
            {
                label: 'KD',
                data: [],
                fill: false,
                backgroundColor: 'green',
                borderColor: 'green',
                borderWidth: 3,
                tension: 0.05
            }]
        };

        // Aqui exibe no console que os dados foram recebidos pela função obter e foram passados pro plotar.
        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            // Variável registro é a resposta[contador]
            var registro = resposta[i];
            // Envia na label o idPartida do gráfico, sendo o título
            labels.push(`Partida: ${registro.idPartida}`);
            // Aqui pega os dados de kills e deaths
            dados.datasets[0].data.push(registro.kills);
            dados.datasets[1].data.push(registro.deaths);
            dados.datasets[2].data.push(registro.kd);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        // Define o tipo de gráfico e os dados que serão exibidos
        const config = {
            type: 'line',
            data: dados,
            options: {
                scales: {
                y: {
                    title: {
                        display: true,
                        text: 'Kills / KD / Deaths',
                        color: '#D9A303',
                        font: {
                            weight: 'bold',
                            size: 16,
                            family: 'Oswald'
                        }
                    },
                    min: 0,
                    max: 20,
                    ticks: {
                        stepSize: 2
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.300)',
                        borderColor: 'red',
                        borderWidth: 2
                    }
                }
            }
            }
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`myChartCanvas${idPartida}`),
            config
        );

        // Define cooldown para ficar atualizando o gráfico e chamar a função
        setTimeout(() => atualizarGrafico(idPartida, dados, myChart), 2000);
    }


    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGrafico(idPartida, dados, myChart) {


        // Busca em medidasPartidas.routes a função de tempo-real pra atualizar o gráfico
        fetch(`/medidasPartidas/tempo-real/${idUsuario}`, { cache: 'no-store' }).then(function (response) {
            // Se a função der certo:
            if (response.ok) {
                // então chama função novoRegistro
                response.json().then(function (novoRegistro) {

                    // obtemDados a partir do idPartida
                    // alertar(novoRegistro, idPartida);
                    // Mostra no console os ddos recebidos e os atuais
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);


                    // Se o novoRegistro do gráfico(no caso o último tamanho) for igual ao
                    // tamanho de dados (tipo, imagina ter 4 registros e o idPartida gráfico for 4)
                    // Ele vai entender que não adiconou novo registro
                    let ultimoLabel = dados.labels[dados.labels.length - 1].replace("Partida: ", "");
                    if (novoRegistro[0].idPartida == ultimoLabel) {
                        // Vai mostrar no console uma frase enorme e um aviso na página
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        console.log("ID do dado atual capturado:")
                        console.log(novoRegistro[0].idPartida)
                        console.log("---------------------------------------------------------------")
                    } else {
                        // Agora se tiver dado novo...
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro (shift apaga o primeiro dado
                        // exibido no Gráfico do Chart.js)
                        dados.labels.push(`Partida: ${novoRegistro[0].idPartida}`); // incluir um novo idPartida no gráfico

                        dados.datasets[0].data.shift();  // apagar o primeiro dado de kills
                        dados.datasets[0].data.push(novoRegistro[0].kills); // incluir uma nova medida de kills

                        dados.datasets[1].data.shift();  // apagar o primeiro de deaths
                        dados.datasets[1].data.push(novoRegistro[0].deaths); // incluir uma nova medida de deaths

                        dados.datasets[2].data.shift();  // apagar o primeiro de kd
                        dados.datasets[2].data.push(novoRegistro[0].kd); // incluir uma nova medida de kd

                        // serve pra atualizar o gráfico do chart.js
                        myChart.update();
                    }

                    // Altere aqui o valor em milesegundos se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idPartida, dados, myChart), 2000);
                });
            } else {
                // Caso não tenha dados ou tenha dado erro, mostra isso (nesse caso, o usuário)
                // Não tem nenhum dado ainda
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em milesegundos se quiser que o gráfico atualize mais rápido ou mais devagar
                // abaixo serve pra chamar a função proximaAtualizacao em um intervalo de 2s
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idPartida, dados, myChart), 2000);
            }
        })
        // Abaixo define o erro que aparece no console
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }
</script>